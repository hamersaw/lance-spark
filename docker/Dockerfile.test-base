# syntax=docker/dockerfile:1

FROM ubuntu:24.04

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      curl \
      openjdk-17-jdk-headless \
      python3 \
      python3-dev \
      python3-venv \
      python3-pip \
      nodejs npm && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN npm install -g azurite

RUN python3 -m venv /opt/venv && \
    . /opt/venv/bin/activate && \
    pip install --upgrade pip && \
    pip install pytest pytest-timeout packaging azure-storage-blob

ENV PATH="/opt/venv/bin:$PATH"
ENV SPARK_HOME="/opt/spark"
ENV PYTHONPATH="${SPARK_HOME}/python:${PYTHONPATH}"
ENV PATH="${SPARK_HOME}/sbin:${SPARK_HOME}/bin:${PATH}"

ARG SPARK_DOWNLOAD_VERSION=4.0.0
ARG SPARK_MAJOR_VERSION=4.0
ARG SCALA_VERSION=2.13
ARG PY4J_VERSION=0.10.9.9
ARG SPARK_SCALA_SUFFIX=

ENV PYTHONPATH="${SPARK_HOME}/python/lib/py4j-${PY4J_VERSION}-src.zip:${PYTHONPATH}"

RUN mkdir -p ${SPARK_HOME} \
    && curl https://archive.apache.org/dist/spark/spark-${SPARK_DOWNLOAD_VERSION}/spark-${SPARK_DOWNLOAD_VERSION}-bin-hadoop3${SPARK_SCALA_SUFFIX}.tgz \
       -o spark.tgz \
    && tar xzf spark.tgz --directory ${SPARK_HOME} --strip-components 1 \
    && rm spark.tgz
