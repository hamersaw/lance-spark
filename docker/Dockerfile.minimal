# syntax=docker/dockerfile:1
#
# Minimal image for running lance-spark integration tests.
# Layers are ordered so that package installation is cached and only
# the Spark download + bundle JAR copy run on each rebuild.

FROM ubuntu:24.04

# --- Cached layers: system packages and Python test deps ---
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      curl \
      openjdk-17-jdk-headless \
      python3 \
      python3-dev \
      python3-venv \
      python3-pip && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN python3 -m venv /opt/venv && \
    . /opt/venv/bin/activate && \
    pip install --upgrade pip && \
    pip install pytest pytest-timeout packaging

ENV PATH="/opt/venv/bin:$PATH"
ENV SPARK_HOME="/opt/spark"
ENV PYTHONPATH="${SPARK_HOME}/python:${PYTHONPATH}"
ENV PATH="${SPARK_HOME}/sbin:${SPARK_HOME}/bin:${PATH}"

ARG SPARK_DOWNLOAD_VERSION=4.0.0
ARG SPARK_MAJOR_VERSION=4.0
ARG SCALA_VERSION=2.13
ARG PY4J_VERSION=0.10.9.9
ARG SPARK_SCALA_SUFFIX=

ENV PYTHONPATH="${SPARK_HOME}/python/lib/py4j-${PY4J_VERSION}-src.zip:${PYTHONPATH}"

RUN mkdir -p ${SPARK_HOME} \
    && curl https://archive.apache.org/dist/spark/spark-${SPARK_DOWNLOAD_VERSION}/spark-${SPARK_DOWNLOAD_VERSION}-bin-hadoop3${SPARK_SCALA_SUFFIX}.tgz \
       -o spark.tgz \
    && tar xzf spark.tgz --directory ${SPARK_HOME} --strip-components 1 \
    && rm spark.tgz

# --- Uncached layers: Spark download and bundle JAR ---

# Add a random query as a cache buster
ADD "https://www.random.org/cgi-bin/randbyte?nbytes=10&format=h" skipcache

COPY lance-spark-bundle-${SPARK_MAJOR_VERSION}_${SCALA_VERSION}-*.jar ${SPARK_HOME}/jars/

# Spark configuration and entrypoint
COPY spark-defaults.conf ${SPARK_HOME}/conf/
RUN chmod u+x ${SPARK_HOME}/sbin/* && \
    chmod u+x ${SPARK_HOME}/bin/*

# Create directories for Spark events and test data
RUN mkdir -p /home/lance/warehouse /home/lance/spark-events /home/lance/data

# Copy tests
RUN mkdir -p /home/lance/tests
COPY tests/ /home/lance/tests/

WORKDIR ${SPARK_HOME}
COPY entrypoint.sh .

ENTRYPOINT ["./entrypoint.sh"]
CMD ["tail", "-f", "/dev/null"]
